<!DOCTYPE html>
<html>
<head>
    <title>Advanced Quiz Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <style>
        /* ... (keep all the CSS from your provided code) ... */
        /* ADDITIONAL STYLES */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, #4169e1, #6a5acd);
            color: white;
            transition: transform 0.3s;
            transform: translateX(-100%);
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-nav a {
            color: white;
            padding: 15px 20px;
            display: block;
            transition: background 0.3s;
        }
        .sidebar-nav a:hover {
            background: rgba(255,255,255,0.1);
        }
        .sidebar-toggle {
            position: fixed;
            left: 30px;
            top: 30px;
            z-index: 1001;
            color: #4169e1;
            cursor: pointer;
            font-size: 1.5rem;
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .sidebar-toggle {
                display: none;
            }
        }
    </style>
</head>
<body class="p-4">
    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <h4>Admin Panel</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="#" onclick="showSection('title')"><i class="bi bi-pencil-square me-2"></i> Quiz Title</a>
            <a href="#" onclick="showSection('create')"><i class="bi bi-plus-circle me-2"></i> New Question</a>
            <a href="#" onclick="showSection('bank')"><i class="bi bi-archive me-2"></i> Question Bank</a>
            <a href="#" onclick="generateQuiz()"><i class="bi bi-file-earmark-check me-2"></i> Generate Quiz</a>
        </nav>
    </div>
    
    <!-- Sidebar Toggle -->
    <button class="btn btn-primary sidebar-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <div class="container main-content">
        <!-- Quiz Title Section -->
        <div class="card shadow mb-4 title-section" id="titleSection">
            <!-- ... (keep your existing title section HTML) ... -->
        </div>

        <!-- Question Creation Section -->
        <div class="card shadow mb-4" id="createSection">
            <!-- ... (keep your existing question creation HTML) ... -->
        </div>

        <!-- Question Bank Section -->
        <div class="card question-bank-card shadow" id="bankSection">
            <!-- ... (keep your existing question bank HTML) ... -->
        </div>
    </div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDkvovInia-45QJpz1FS9CEVJ5jc2XkLlE",
  authDomain: "quiz-1111-e7d1a.firebaseapp.com",
  projectId: "quiz-1111-e7d1a",
  storageBucket: "quiz-1111-e7d1a.firebasestorage.app",
  messagingSenderId: "420378130829",
  appId: "1:420378130829:web:3a19a496478f0ce10f65c4",
  measurementId: "G-FP2P2MLTVB"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentSection = 'title';
let listView = 'grid';
let editDocId = null;

// Loader control
function showLoader() {
    document.getElementById('loader').style.display = 'flex';
}
function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

// Sidebar control
function toggleSidebar() {
    document.getElementById('adminSidebar').classList.toggle('active');
}
function showSection(section) {
    document.querySelectorAll('.main-content > div').forEach(el => {
        el.style.display = 'none';
    });
    document.getElementById(`${section}Section`).style.display = 'block';
    currentSection = section;
}

// Title Management Functions
function saveQuizTitle() {
    // ... (keep your existing title functions)
}

// Firebase-powered Question Management
function renderQuestions(filter = '') {
    showLoader();
    db.collection('quizzes').get().then(snapshot => {
        const list = document.getElementById('questionsList');
        const noQuestions = document.getElementById('noQuestions');
        const filtered = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            if(data.question.toLowerCase().includes(filter.toLowerCase())) {
                filtered.push({
                    id: doc.id,
                    question: data.question,
                    options: data.options.map(opt => opt.text),
                    correctAnswer: data.options.find(opt => opt.isCorrect)?.text
                });
            }
        });

        list.innerHTML = filtered.map(q => `
            <div class="col-md-6 col-lg-4 ${listView === 'list' ? 'col-12' : ''}">
                <div class="card h-100 question-item">
                    <div class="card-body d-flex flex-column">
                        <div class="question-header mb-3">
                            <h6 class="m-0">${q.question}</h6>
                        </div>
                        <div class="answer-list mb-3">
                            ${q.options.map(opt => 
                                `<div class="d-flex align-items-center mb-2">
                                    <span class="badge ${opt === q.correctAnswer ? 
                                        'bg-success' : 'bg-secondary'} me-2">
                                        ${opt === q.correctAnswer ? 'âœ“' : ''}
                                    </span>
                                    <span>${opt}</span>
                                </div>`
                            ).join('')}
                        </div>
                        <div class="mt-auto d-flex flex-column gap-2">
                            <div class="question-stats">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Correct answer: ${q.correctAnswer}
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-warning btn-action" onclick="copyQuestion('${q.id}')">
                                    <i class="bi bi-files"></i>
                                </button>
                                <button class="btn btn-info btn-action" onclick="previewQuestion('${q.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <div class="dropdown ms-auto">
                                    <button class="btn btn-light btn-action" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editQuestion('${q.id}')">
                                            <i class="bi bi-pencil-square me-2"></i> Edit
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteQuestion('${q.id}')">
                                            <i class="bi bi-trash me-2"></i> Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        noQuestions.classList.toggle('d-none', filtered.length > 0);
        hideLoader();
    });
}

// CRUD Operations with Firebase
function handleSave() {
    const question = document.getElementById('questionText').value.trim();
    const answersText = document.getElementById('answersArea').value;
    const rawAnswers = answersText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    
    if (!validateInput(question, rawAnswers)) return;
    
    const options = rawAnswers.map(opt => ({
        text: opt.replace(/^\*/, '').trim(),
        isCorrect: opt.startsWith('*')
    }));

    showLoader();
    
    if (editDocId) {
        db.collection('quizzes').doc(editDocId).update({
            question: question,
            options: options
        }).then(() => {
            showToast('Question updated!', 'info');
            clearForm();
        }).finally(hideLoader);
    } else {
        db.collection('quizzes').add({
            question: question,
            options: options,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            showToast('Question added!', 'success');
            clearForm();
        }).finally(hideLoader);
    }
}

function editQuestion(id) {
    showLoader();
    db.collection('quizzes').doc(id).get().then(doc => {
        const data = doc.data();
        document.getElementById('questionText').value = data.question;
        document.getElementById('answersArea').value = data.options
            .map(opt => opt.isCorrect ? `*${opt.text}` : opt.text)
            .join('\n');
        editDocId = id;
        document.querySelector('.btn-primary').innerHTML = 
            '<i class="bi bi-save me-2"></i> Update Question';
        hideLoader();
        showSection('create');
    });
}

function deleteQuestion(id) {
    if (confirm('Are you sure?')) {
        showLoader();
        db.collection('quizzes').doc(id).delete().then(() => {
            showToast('Question deleted!', 'danger');
        }).finally(hideLoader);
    }
}

function copyQuestion(id) {
    showLoader();
    db.collection('quizzes').doc(id).get().then(doc => {
        const data = doc.data();
        document.getElementById('questionText').value = data.question + ' (Copy)';
        document.getElementById('answersArea').value = data.options
            .map(opt => opt.isCorrect ? `*${opt.text}` : opt.text)
            .join('\n');
        showToast('Question copied!', 'info');
        hideLoader();
        showSection('create');
    });
}

function previewQuestion(id) {
    showLoader();
    db.collection('quizzes').doc(id).get().then(doc => {
        const data = doc.data();
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${data.question}</h6>
                        <div class="mt-3">
                            ${data.options.map(opt => 
                                `<div class="form-check">
                                    <input class="form-check-input" type="radio" disabled 
                                        ${opt.isCorrect ? 'checked' : ''}>
                                    <label class="form-check-label">${opt.text}</label>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
        hideLoader();
    });
}

function generateQuiz() {
    saveQuizTitle();
    db.collection('quizzes').get().then(snapshot => {
        if (snapshot.empty) {
            showToast('No questions!', 'warning');
            return;
        }
        showToast('Quiz generated!', 'success');
        setTimeout(() => {
            window.location.href = 'quiz.html';
        }, 1500);
    });
}

// Validation and Helpers
function validateInput(question, answers) {
    if (!question) {
        showToast('Question required', 'danger');
        return false;
    }
    if (answers.length < 2) {
        showToast('Minimum 2 answers', 'danger');
        return false;
    }
    if (!answers.some(ans => ans.startsWith('*'))) {
        showToast('Mark correct answer', 'danger');
        return false;
    }
    return true;
}

function clearForm() {
    document.getElementById('questionText').value = '';
    document.getElementById('answersArea').value = '';
    editDocId = null;
    document.querySelector('.btn-primary').innerHTML = 
        '<i class="bi bi-plus-circle me-2"></i> Add Question';
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = '1000';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
    bsToast.show();
    setTimeout(() => {
        toast.remove();
    }, 3500);
}

// Event Listeners
document.getElementById('searchInput').addEventListener('input', (e) => {
    renderQuestions(e.target.value);
});

db.collection('quizzes').onSnapshot(() => {
    renderQuestions(document.getElementById('searchInput').value);
});

// Initialization
showLoader();
document.addEventListener('DOMContentLoaded', () => {
    hideLoader();
    showSection('title');
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
